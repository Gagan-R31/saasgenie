name: CI/CD Pipeline

on:
  pull_request:
    branches: 
      - main
      - staging
    types: [opened, synchronize, reopened]
  push:
    branches: 
      - main
      - staging

jobs:
  detect_changes:
    uses: ./.github/workflows/detect-changes.yaml

  verify:
    if: ${{ needs.detect_changes.outputs.code_changed == 'true' }}
    needs: detect_changes
    uses: ./.github/workflows/verify.yaml
    with:
      code_changed: ${{ needs.detect_changes.outputs.code_changed }}
      changed_services: ${{ needs.detect_changes.outputs.changed_services }}

  build_and_push:
    needs: [verify, detect_changes]
    uses: ./.github/workflows/build-push.yaml
    with:
      changed_services: ${{ needs.detect_changes.outputs.changed_services }}
      source_branch: ${{ github.head_ref || github.ref_name }}
    secrets:
      REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

  auto_deploy_production:
    # Auto-deploy only when pushing to main (after merge)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build_and_push, detect_changes]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl cluster-info
      
      - name: Deploy to production using Makefile
        run: |
          changed_services=$(echo '${{ needs.detect_changes.outputs.changed_services }}' | jq -r '.[]')
          
          for service in $changed_services; do
            echo "=========================================="
            echo "Deploying $service to production..."
            echo "=========================================="
            
            cd services/$service
            
            # Determine image name
            if [ "$service" == "web-ui" ]; then
              IMAGE_NAME="demo"
            else
              IMAGE_NAME="mg-fp-$service"
            fi
            
            FULL_IMAGE="gaganr31/${IMAGE_NAME}:latest"
            
            # Update deployment.yaml with the new image
            if [ -f "k8s/base/deployment.yaml" ]; then
              echo "Updating deployment.yaml with image: ${FULL_IMAGE}"
              sed -i "s|image: .*${IMAGE_NAME}.*|image: ${FULL_IMAGE}|g" k8s/base/deployment.yaml
              
              # Deploy using Makefile
              FALCON_HOME=$GITHUB_WORKSPACE \
              KUBE_ENV=production \
              REGISTRY=gaganr31 \
              IMAGE_NAME=$IMAGE_NAME \
              IMAGE_TAG_SHA=latest \
              make deploy
              
              echo "✅ Production deployment complete for $service"
            else
              echo "⚠️  No k8s/base/deployment.yaml found for $service, skipping deployment"
            fi
            
            cd -
          done
      
      - name: Verify deployment
        run: |
          kubectl get deployments -n default
          kubectl get pods -n default -l app=demo