name: Build & Push

on:
  workflow_call:
    inputs:
      changed_services:
        type: string
        required: true
      source_branch:
        type: string
        required: false
        default: ''
    secrets:
      REGISTRY_PASSWORD:
        required: true

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Setup Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Setup cache
      - name: Setup Docker cache
        uses: actions/cache@v4
        id: docker-cache
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ github.sha }}
          restore-keys: |
            buildx-

      - name: Log in to container registry
        uses: docker/login-action@v2
        with:
            username: gaganr31
            password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Determine branch and tags
        id: tags
        run: |
          # Get source branch name
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PR, use the head branch (source branch)
            SOURCE_BRANCH="${{ github.head_ref }}"
            TARGET_BRANCH="${{ github.base_ref }}"
          else
            # For push, use the branch being pushed to
            SOURCE_BRANCH="${{ github.ref_name }}"
            TARGET_BRANCH="${{ github.ref_name }}"
          fi
          
          echo "source_branch=${SOURCE_BRANCH}" >> $GITHUB_OUTPUT
          echo "target_branch=${TARGET_BRANCH}" >> $GITHUB_OUTPUT
          
          # Set environment tag based on source branch
          if [ "$SOURCE_BRANCH" == "staging" ]; then
            ENV_TAG="staging"
            KUBE_ENV="staging"
          elif [ "$SOURCE_BRANCH" == "main" ]; then
            ENV_TAG="production"
            KUBE_ENV="production"
          else
            # For feature branches, use branch name as tag (sanitize for Docker)
            ENV_TAG=$(echo "$SOURCE_BRANCH" | sed 's/[^a-zA-Z0-9._-]/-/g')
            KUBE_ENV="dev"
          fi
          
          echo "env_tag=${ENV_TAG}" >> $GITHUB_OUTPUT
          echo "kube_env=${KUBE_ENV}" >> $GITHUB_OUTPUT
          echo "Source Branch: ${SOURCE_BRANCH}"
          echo "Target Branch: ${TARGET_BRANCH}"
          echo "Environment Tag: ${ENV_TAG}"
          echo "Kube Environment: ${KUBE_ENV}"

      - name: Build and Push Docker Images using Makefile
        run: |
          changed_services=$(echo '${{ inputs.changed_services }}' | jq -r '.[]')
          for service in $changed_services; do
            echo "=========================================="
            echo "Building and pushing $service..."
            echo "=========================================="
            cd services/$service
            
            # Determine image name based on service
            if [ "$service" == "web-ui" ]; then
              IMAGE_NAME="demo"
            else
              IMAGE_NAME="mg-fp-$service"
            fi
            
            SOURCE_BRANCH="${{ steps.tags.outputs.source_branch }}"
            ENV_TAG="${{ steps.tags.outputs.env_tag }}"
            KUBE_ENV="${{ steps.tags.outputs.kube_env }}"
            
            # Build and push using Makefile
            FALCON_HOME=$GITHUB_WORKSPACE \
            KUBE_ENV=$KUBE_ENV \
            REGISTRY=gaganr31 \
            IMAGE_NAME=$IMAGE_NAME \
            IMAGE_TAG_SHA=${{ github.sha }} \
            SHOULD_CACHE=true \
            SHOULD_PUSH=true \
            make build
            
            # Tag with branch-specific tag
            docker tag gaganr31/$IMAGE_NAME:${{ github.sha }} gaganr31/$IMAGE_NAME:$ENV_TAG
            docker push gaganr31/$IMAGE_NAME:$ENV_TAG
            echo "âœ… Pushed: gaganr31/$IMAGE_NAME:$ENV_TAG"
            
            # Push 'latest' tag only when merging to main (not on PR)
            if [ "$SOURCE_BRANCH" == "main" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
              docker tag gaganr31/$IMAGE_NAME:${{ github.sha }} gaganr31/$IMAGE_NAME:latest
              docker push gaganr31/$IMAGE_NAME:latest
              echo "âœ… Pushed: gaganr31/$IMAGE_NAME:latest"
            fi
            
            echo ""
            echo "ðŸ“¦ Summary for $service:"
            echo "  - Commit SHA tag: gaganr31/$IMAGE_NAME:${{ github.sha }}"
            echo "  - Branch tag: gaganr31/$IMAGE_NAME:$ENV_TAG"
            if [ "$SOURCE_BRANCH" == "main" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
              echo "  - Latest tag: gaganr31/$IMAGE_NAME:latest"
            fi
            
            cd -
          done
      
      - name: Output image tags
        run: |
          echo "## ðŸ³ Docker Images Built & Pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source Branch:** ${{ steps.tags.outputs.source_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** ${{ steps.tags.outputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment Tag:** ${{ steps.tags.outputs.env_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Kube Environment:** ${{ steps.tags.outputs.kube_env }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Built:" >> $GITHUB_STEP_SUMMARY
          
          changed_services=$(echo '${{ inputs.changed_services }}' | jq -r '.[]')
          for service in $changed_services; do
            if [ "$service" == "web-ui" ]; then
              IMAGE_NAME="demo"
            else
              IMAGE_NAME="mg-fp-$service"
            fi
            echo "- **$service** â†’ \`gaganr31/$IMAGE_NAME:${{ steps.tags.outputs.env_tag }}\`" >> $GITHUB_STEP_SUMMARY
          done