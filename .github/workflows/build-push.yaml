name: Build & Push

on:
  workflow_call:
    inputs:
      changed_services:
        type: string
        required: true
      source_branch:
        type: string
        required: false
        default: ''
    secrets:
      REGISTRY_PASSWORD:
        required: true

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Setup Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Setup cache
      - name: Setup Docker cache
        uses: actions/cache@v4
        id: docker-cache
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ github.sha }}
          restore-keys: |
            buildx-

      - name: Log in to container registry
        uses: docker/login-action@v2
        with:
            username: gaganr31
            password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Determine branch and tags
        id: tags
        run: |
          # Get source branch name
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PR, use the head branch (source branch)
            SOURCE_BRANCH="${{ github.head_ref }}"
            TARGET_BRANCH="${{ github.base_ref }}"
          else
            # For push, use the branch being pushed to
            SOURCE_BRANCH="${{ github.ref_name }}"
            TARGET_BRANCH="${{ github.ref_name }}"
          fi
          
          echo "source_branch=${SOURCE_BRANCH}" >> $GITHUB_OUTPUT
          echo "target_branch=${TARGET_BRANCH}" >> $GITHUB_OUTPUT
          
          # Set environment tag based on source branch
          if [ "$SOURCE_BRANCH" == "staging" ]; then
            ENV_TAG="staging"
          elif [ "$SOURCE_BRANCH" == "main" ]; then
            ENV_TAG="production"
          else
            # For feature branches, use branch name as tag (sanitize for Docker)
            ENV_TAG=$(echo "$SOURCE_BRANCH" | sed 's/[^a-zA-Z0-9._-]/-/g')
          fi
          
          echo "env_tag=${ENV_TAG}" >> $GITHUB_OUTPUT
          echo "Source Branch: ${SOURCE_BRANCH}"
          echo "Target Branch: ${TARGET_BRANCH}"
          echo "Environment Tag: ${ENV_TAG}"

      - name: Build Docker Images
        run: |
          changed_services=$(echo '${{ inputs.changed_services }}' | jq -r '.[]')
          for service in $changed_services; do
            echo "Building $service..."
            cd services/$service
            
            # Determine image name based on service
            if [ "$service" == "web-ui" ]; then
              IMAGE_NAME="demo"
            else
              IMAGE_NAME="mg-fp-$service"
            fi
            
            FALCON_HOME=$GITHUB_WORKSPACE KUBE_ENV=dev make build \
              REGISTRY=gaganr31 \
              IMAGE_NAME=$IMAGE_NAME \
              IMAGE_TAG_SHA=${{ github.sha }} \
              SHOULD_CACHE=true SHOULD_PUSH=false
            cd -
          done
      
      - name: Push Docker Images
        run: |
          changed_services=$(echo '${{ inputs.changed_services }}' | jq -r '.[]')
          for service in $changed_services; do
            echo "Pushing $service..."
            
            # Determine image name based on service
            if [ "$service" == "web-ui" ]; then
              IMAGE_NAME="demo"
            else
              IMAGE_NAME="mg-fp-$service"
            fi
            
            BASE_IMAGE=gaganr31/$IMAGE_NAME
            SOURCE_BRANCH="${{ steps.tags.outputs.source_branch }}"
            ENV_TAG="${{ steps.tags.outputs.env_tag }}"
            
            # Always push commit SHA tag
            docker push $BASE_IMAGE:${{ github.sha }}
            echo "âœ… Pushed: $BASE_IMAGE:${{ github.sha }}"
            
            # Push branch-specific tag
            docker tag $BASE_IMAGE:${{ github.sha }} $BASE_IMAGE:$ENV_TAG
            docker push $BASE_IMAGE:$ENV_TAG
            echo "âœ… Pushed: $BASE_IMAGE:$ENV_TAG"
            
            # Only push 'latest' tag when merging to main (not on PR)
            if [ "$SOURCE_BRANCH" == "main" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
              docker tag $BASE_IMAGE:${{ github.sha }} $BASE_IMAGE:latest
              docker push $BASE_IMAGE:latest
              echo "âœ… Pushed: $BASE_IMAGE:latest"
            fi
            
            echo ""
            echo "ðŸ“¦ Summary for $service:"
            echo "  - Commit SHA tag: $BASE_IMAGE:${{ github.sha }}"
            echo "  - Branch tag: $BASE_IMAGE:$ENV_TAG"
            if [ "$SOURCE_BRANCH" == "main" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
              echo "  - Latest tag: $BASE_IMAGE:latest"
            fi
          done
      
      - name: Output image tags
        run: |
          echo "## ðŸ³ Docker Images Built & Pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source Branch:** ${{ steps.tags.outputs.source_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** ${{ steps.tags.outputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment Tag:** ${{ steps.tags.outputs.env_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Tags:" >> $GITHUB_STEP_SUMMARY
          echo "- \`gaganr31/demo:${{ github.sha }}\` (commit-specific)" >> $GITHUB_STEP_SUMMARY
          echo "- \`gaganr31/demo:${{ steps.tags.outputs.env_tag }}\` (branch-specific)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.tags.outputs.source_branch }}" == "main" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "- \`gaganr31/demo:latest\` (production)" >> $GITHUB_STEP_SUMMARY
          fi