name: Build & Push

on:
  workflow_call:
    inputs:
      changed_services:
        type: string
        required: true
    secrets:
      REGISTRY_PASSWORD:
        required: true

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Setup Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Setup cache
      - name: Setup Docker cache
        uses: actions/cache@v4
        id: docker-cache
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ github.sha }}
          restore-keys: |
            buildx-

      - name: Log in to container registry
        uses: docker/login-action@v2
        with:
            username: gaganr31
            password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Determine branch and tags
        id: tags
        run: |
          # Get branch name
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH_NAME="${{ github.base_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          
          echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          
          # Set environment tag based on branch
          if [ "$BRANCH_NAME" == "staging" ]; then
            ENV_TAG="staging"
          elif [ "$BRANCH_NAME" == "main" ]; then
            ENV_TAG="production"
          else
            ENV_TAG="dev"
          fi
          
          echo "env_tag=${ENV_TAG}" >> $GITHUB_OUTPUT
          echo "Deploying to environment: ${ENV_TAG}"

      - name: Build Docker Images
        run: |
          changed_services=$(echo '${{ inputs.changed_services }}' | jq -r '.[]')
          for service in $changed_services; do
            echo "Building $service..."
            cd services/$service
            
            # Determine image name based on service
            if [ "$service" == "web-ui" ]; then
              IMAGE_NAME="demo"
            else
              IMAGE_NAME="mg-fp-$service"
            fi
            
            FALCON_HOME=$GITHUB_WORKSPACE KUBE_ENV=dev make build \
              REGISTRY=gaganr31 \
              IMAGE_NAME=$IMAGE_NAME \
              IMAGE_TAG_SHA=${{ github.sha }} \
              SHOULD_CACHE=true SHOULD_PUSH=false
            cd -
          done
      
      - name: Push Docker Images
        run: |
          changed_services=$(echo '${{ inputs.changed_services }}' | jq -r '.[]')
          for service in $changed_services; do
            echo "Pushing $service..."
            
            # Determine image name based on service
            if [ "$service" == "web-ui" ]; then
              IMAGE_NAME="demo"
            else
              IMAGE_NAME="mg-fp-$service"
            fi
            
            BASE_IMAGE=gaganr31/$IMAGE_NAME
            
            # Always push commit SHA tag
            docker push $BASE_IMAGE:${{ github.sha }}
            
            # Push environment-specific tag (staging or production)
            docker tag $BASE_IMAGE:${{ github.sha }} $BASE_IMAGE:${{ steps.tags.outputs.env_tag }}
            docker push $BASE_IMAGE:${{ steps.tags.outputs.env_tag }}
            
            # Push latest only for main branch
            if [ "${{ steps.tags.outputs.branch }}" == "main" ]; then
              docker tag $BASE_IMAGE:${{ github.sha }} $BASE_IMAGE:latest
              docker push $BASE_IMAGE:${{ steps.tags.outputs.env_tag }}
            fi
            
            echo "âœ… Pushed tags:"
            echo "  - $BASE_IMAGE:${{ github.sha }}"
            echo "  - $BASE_IMAGE:${{ steps.tags.outputs.env_tag }}"
            if [ "${{ steps.tags.outputs.branch }}" == "main" ]; then
              echo "  - $BASE_IMAGE:latest"
            fi
          done
      
      - name: Output image tags
        run: |
          echo "## ðŸ³ Docker Images Built & Pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.tags.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.tags.outputs.env_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Tags:" >> $GITHUB_STEP_SUMMARY
          echo "- \`gaganr31/demo:${{ github.sha }}\` (commit-specific)" >> $GITHUB_STEP_SUMMARY
          echo "- \`gaganr31/demo:${{ steps.tags.outputs.env_tag }}\` (environment)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.tags.outputs.branch }}" == "main" ]; then
            echo "- \`gaganr31/demo:latest\` (production)" >> $GITHUB_STEP_SUMMARY
          fi