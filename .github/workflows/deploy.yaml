name: Build & Deploy

on:
  workflow_call:
    inputs:
      changed_services:
        type: string
        required: true
    secrets:
      REGISTRY_PASSWORD:
        required: true
      KUBECONFIG:
        required: true

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    environment: default
    steps:
      - uses: actions/checkout@v4

      # Setup Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Setup cache
      - name: Setup Docker cache
        uses: actions/cache@v4
        id: docker-cache
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ github.sha }}
          restore-keys: |
            buildx-

      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
          # Test connection
          kubectl cluster-info
          kubectl get nodes

      - name: Log in to container registry
        uses: docker/login-action@v2
        with:
            username: gaganr31
            password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build Docker Images
        run: |
          changed_services=$(echo '${{ inputs.changed_services }}' | jq -r '.[]')
          for service in $changed_services; do
            echo "Building $service..."
            cd services/$service
            
            # Determine image name based on service
            if [ "$service" == "web-ui" ]; then
              IMAGE_NAME="demo"
            else
              IMAGE_NAME="mg-fp-$service"
            fi
            
            FALCON_HOME=$GITHUB_WORKSPACE KUBE_ENV=dev make build \
              REGISTRY=gaganr31 \
              IMAGE_NAME=$IMAGE_NAME \
              IMAGE_TAG_SHA=${{ github.sha }} \
              SHOULD_CACHE=true SHOULD_PUSH=false
            cd -
          done
      
      - name: Push Docker Images
        if: github.ref == 'refs/heads/main'
        run: |
          changed_services=$(echo '${{ inputs.changed_services }}' | jq -r '.[]')
          for service in $changed_services; do
            echo "Pushing $service..."
            
            # Determine image name based on service
            if [ "$service" == "web-ui" ]; then
              IMAGE_NAME="demo"
            else
              IMAGE_NAME="mg-fp-$service"
            fi
            
            IMAGE_TAG=gaganr31/$IMAGE_NAME
            docker push $IMAGE_TAG:${{ github.sha }}
            docker push $IMAGE_TAG:latest
          done

      # Deploy to Kubernetes
      - name: Deploy to K8s
        if: github.ref == 'refs/heads/main'
        run: |
          kubectl config current-context

          changed_services=$(echo '${{ inputs.changed_services }}' | jq -r '.[]')

          if [ -z "$changed_services" ]; then
            echo "No services to deploy."
            exit 0
          fi

          for service in $changed_services; do
            echo "Processing deployment for: $service"
            
            # Handle web-ui service
            if [ "$service" == "web-ui" ]; then
              cd services/$service
              echo "Deploying $service..."

              # Update the image in deployment.yaml
              sed -i'' -e "s|image: .*|image: gaganr31/demo:${{ github.sha }}|g" k8s/base/deployment.yaml

              # Deploy using Makefile
              FALCON_HOME=$GITHUB_WORKSPACE make deploy KUBE_ENV=dev
              cd -
            fi
            
            # Handle rest-controller service (original logic)
            if [ "$service" == "rest-controller" ]; then
              cd services/$service
              echo "Deploying $service..."

              # Use the versioned image to trigger deployment
              sed -i'' -e "s|image: .*|image: ${{ vars.REGISTRY_URL }}/mg-fp-${service}:${{ github.sha }}|g" k8s/base/deployment.yaml

              FALCON_HOME=$GITHUB_WORKSPACE make deploy KUBE_ENV=dev
              cd -
            fi
        
            # Handle kafka-ui service (original logic)
            if [ "$service" == "kafka-ui" ]; then
              echo "Deploying $service..."
              kubectl apply -k services/${service}/k8s/base
              cd -
            fi
          done
          
      - name: Verify Deployment
        if: github.ref == 'refs/heads/main'
        run: |
          changed_services=$(echo '${{ inputs.changed_services }}' | jq -r '.[]')
          
          for service in $changed_services; do
            if [ "$service" == "web-ui" ]; then
              echo "Verifying web-ui deployment..."
              kubectl get deployment demo -n default
              kubectl get pods -n default -l app=demo
              echo "âœ… Web UI deployment verified"
            fi
          done