name: Manual Deploy to AKS

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to build and deploy'
        required: true
        type: string
        default: 'main'
      deploy_option:
        description: 'Deployment option'
        required: true
        type: choice
        options:
          - 'Deploy all changed services'
          - 'Deploy specific service'
        default: 'Deploy all changed services'
      service_name:
        description: 'Service name (only if "Deploy specific service" is selected)'
        required: false
        type: string
      skip_verify:
        description: 'Skip verification (format check and tests)'
        required: false
        type: boolean
        default: false

env:
  NAMESPACE: default
  DEPLOYMENT_NAME: demo
  REGISTRY: gaganr31

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      changed_services: ${{ steps.detect.outputs.changed_services }}
      services_to_deploy: ${{ steps.detect.outputs.services_to_deploy }}
      code_changed: ${{ steps.detect.outputs.code_changed }}
      kube_env: ${{ steps.detect.outputs.kube_env }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch_name }}

      - id: detect
        shell: bash
        run: |
          BRANCH_NAME="${{ github.event.inputs.branch_name }}"
          DEPLOY_OPTION="${{ github.event.inputs.deploy_option }}"
          SPECIFIC_SERVICE="${{ github.event.inputs.service_name }}"
          
          echo "Detecting changes in branch: ${BRANCH_NAME}"
          echo "Deploy option: ${DEPLOY_OPTION}"
          
          # Determine KUBE_ENV based on branch
          if [ "$BRANCH_NAME" == "main" ]; then
            KUBE_ENV="production"
          elif [ "$BRANCH_NAME" == "staging" ]; then
            KUBE_ENV="staging"
          else
            KUBE_ENV="dev"
          fi
          
          echo "kube_env=${KUBE_ENV}" >> $GITHUB_OUTPUT
          echo "Kube Environment: ${KUBE_ENV}"
          
          # Compare with main branch to detect what services exist/changed
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          else
            # If can't compare with main, just list all services
            CHANGED_FILES=$(find services -type f)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "---"

          code_changed=false
          changed_services=""

          if echo "$CHANGED_FILES" | grep -Eq '^(services|libs)/'; then
            code_changed=true
          fi

          for service_dir in services/*; do
            [ -d "$service_dir" ] || continue
            service_name=$(basename "$service_dir")
            if echo "$CHANGED_FILES" | grep -q "^services/$service_name/"; then
              changed_services="$changed_services $service_name"
            fi
          done

          if echo "$CHANGED_FILES" | grep -q '^libs/'; then
            for service_dir in services/*; do
              [ -d "$service_dir" ] || continue
              service_name=$(basename "$service_dir")
              changed_services="$changed_services $service_name"
            done
          fi

          changed_services=$(echo "$changed_services" | tr ' ' '\n' | sort -u | xargs)

          if [ -z "$changed_services" ]; then
            changed_services_json="[]"
            echo "No services with changes detected"
          else
            changed_services_json=$(printf '%s\n' $changed_services | jq -R . | jq -s -c .)
            echo "Services with changes: $changed_services"
          fi

          # Determine which services to actually deploy
          services_to_deploy=""
          if [ "$DEPLOY_OPTION" == "Deploy specific service" ]; then
            if [ -z "$SPECIFIC_SERVICE" ]; then
              echo "ERROR: service_name is required when 'Deploy specific service' is selected"
              exit 1
            fi
            
            # Check if the specific service exists
            if [ ! -d "services/$SPECIFIC_SERVICE" ]; then
              echo "ERROR: Service '$SPECIFIC_SERVICE' does not exist in the repository"
              echo "Available services:"
              ls -1 services/
              exit 1
            fi
            
            services_to_deploy="$SPECIFIC_SERVICE"
            echo "Deploying specific service: $SPECIFIC_SERVICE"
          else
            # Deploy all changed services
            services_to_deploy="$changed_services"
            echo "Deploying all changed services: $services_to_deploy"
          fi

          if [ -z "$services_to_deploy" ]; then
            services_to_deploy_json="[]"
            echo "No services to deploy"
          else
            services_to_deploy_json=$(printf '%s\n' $services_to_deploy | jq -R . | jq -s -c .)
            echo "Services to deploy: $services_to_deploy"
          fi

          echo "Changed services JSON: $changed_services_json"
          echo "Services to deploy JSON: $services_to_deploy_json"

          echo "code_changed=$code_changed" >> "$GITHUB_OUTPUT"
          echo "changed_services=$changed_services_json" >> "$GITHUB_OUTPUT"
          echo "services_to_deploy=$services_to_deploy_json" >> "$GITHUB_OUTPUT"

  verify:
    name: Verify ${{ matrix.service }}
    needs: detect_changes
    if: ${{ github.event.inputs.skip_verify != 'true' && needs.detect_changes.outputs.services_to_deploy != '[]' && needs.detect_changes.outputs.services_to_deploy != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect_changes.outputs.services_to_deploy) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}
          
      - name: Install dependencies
        working-directory: services/${{ matrix.service }}
        run: |
          if [ -f requirements.txt ]; then
            echo "Installing Python dependencies..."
            pip install -r requirements.txt
          else
            echo "No requirements.txt found in services/${{ matrix.service }}"
          fi

      - name: Build other make dependencies
        working-directory: base-images
        run: |
          FALCON_HOME=${{ github.workspace }} KUBE_ENV=dev make build-lint

      - name: Run formatting check
        working-directory: services/${{ matrix.service }}
        run: |
          echo "Checking code formatting for ${{ matrix.service }}..."
          FALCON_HOME=${{ github.workspace }} KUBE_ENV=dev make check-format

      - name: Run linting
        working-directory: services/${{ matrix.service }}
        run: echo "No linting defined yet"

      - name: Run tests
        working-directory: services/${{ matrix.service }}
        run: |
          echo "Running tests for ${{ matrix.service }}..."
          FALCON_HOME=${{ github.workspace }} KUBE_ENV=dev make test SHOULD_PUSH=false

  build_and_push:
    needs: [detect_changes, verify]
    if: ${{ always() && needs.detect_changes.outputs.services_to_deploy != '[]' && needs.detect_changes.outputs.services_to_deploy != '' && (needs.verify.result == 'success' || needs.verify.result == 'skipped') }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect_changes.outputs.services_to_deploy) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to container registry
        uses: docker/login-action@v2
        with:
          username: ${{ env.REGISTRY }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and Push using Makefile
        run: |
          SERVICE="${{ matrix.service }}"
          BRANCH="${{ github.event.inputs.branch_name }}"
          KUBE_ENV="${{ needs.detect_changes.outputs.kube_env }}"
          
          echo "=========================================="
          echo "Building and pushing $SERVICE..."
          echo "Branch: $BRANCH"
          echo "Kube Environment: $KUBE_ENV"
          echo "=========================================="
          
          cd services/$SERVICE
          
          # Determine image name
          if [ "$SERVICE" == "web-ui" ]; then
            IMAGE_NAME="demo"
          else
            IMAGE_NAME="mg-fp-$SERVICE"
          fi
          
          # Sanitize branch name for Docker tag
          BRANCH_TAG=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9._-]/-/g')
          
          # Build and push using Makefile
          FALCON_HOME=$GITHUB_WORKSPACE \
          KUBE_ENV=$KUBE_ENV \
          REGISTRY=${{ env.REGISTRY }} \
          IMAGE_NAME=$IMAGE_NAME \
          IMAGE_TAG_SHA=${{ github.sha }} \
          SHOULD_CACHE=true \
          SHOULD_PUSH=true \
          make build
          
          echo "âœ… Built and pushed: ${{ env.REGISTRY }}/$IMAGE_NAME:${{ github.sha }}"
          
          # Tag with branch-specific tag
          docker tag ${{ env.REGISTRY }}/$IMAGE_NAME:${{ github.sha }} ${{ env.REGISTRY }}/$IMAGE_NAME:$BRANCH_TAG
          docker push ${{ env.REGISTRY }}/$IMAGE_NAME:$BRANCH_TAG
          echo "âœ… Pushed: ${{ env.REGISTRY }}/$IMAGE_NAME:$BRANCH_TAG"
          
          # Push additional tags for main/staging
          if [ "$BRANCH" == "main" ]; then
            docker tag ${{ env.REGISTRY }}/$IMAGE_NAME:${{ github.sha }} ${{ env.REGISTRY }}/$IMAGE_NAME:latest
            docker push ${{ env.REGISTRY }}/$IMAGE_NAME:latest
            echo "âœ… Pushed: ${{ env.REGISTRY }}/$IMAGE_NAME:latest"
            
            docker tag ${{ env.REGISTRY }}/$IMAGE_NAME:${{ github.sha }} ${{ env.REGISTRY }}/$IMAGE_NAME:production
            docker push ${{ env.REGISTRY }}/$IMAGE_NAME:production
            echo "âœ… Pushed: ${{ env.REGISTRY }}/$IMAGE_NAME:production"
          elif [ "$BRANCH" == "staging" ]; then
            docker tag ${{ env.REGISTRY }}/$IMAGE_NAME:${{ github.sha }} ${{ env.REGISTRY }}/$IMAGE_NAME:staging
            docker push ${{ env.REGISTRY }}/$IMAGE_NAME:staging
            echo "âœ… Pushed: ${{ env.REGISTRY }}/$IMAGE_NAME:staging"
          fi

  deploy:
    needs: [detect_changes, verify, build_and_push]
    if: ${{ always() && needs.detect_changes.outputs.services_to_deploy != '[]' && needs.detect_changes.outputs.services_to_deploy != '' && needs.build_and_push.result == 'success' }}
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.branch_name == 'main' && 'production' || github.event.inputs.branch_name == 'staging' && 'staging' || 'development' }}
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect_changes.outputs.services_to_deploy) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
          echo "Testing cluster connection..."
          kubectl cluster-info

      - name: Deploy using Makefile
        run: |
          SERVICE="${{ matrix.service }}"
          KUBE_ENV="${{ needs.detect_changes.outputs.kube_env }}"
          
          echo "=========================================="
          echo "Deploying $SERVICE to AKS..."
          echo "Kube Environment: $KUBE_ENV"
          echo "=========================================="
          
          cd services/$SERVICE
          
          # Determine image name
          if [ "$SERVICE" == "web-ui" ]; then
            IMAGE_NAME="demo"
          else
            IMAGE_NAME="mg-fp-$SERVICE"
          fi
          
          FULL_IMAGE="${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }}"
          
          # Update deployment.yaml with the new image
          if [ -f "k8s/base/deployment.yaml" ]; then
            echo "Updating deployment.yaml with image: ${FULL_IMAGE}"
            sed -i "s|image: .*${IMAGE_NAME}.*|image: ${FULL_IMAGE}|g" k8s/base/deployment.yaml
            
            # Deploy using Makefile
            FALCON_HOME=$GITHUB_WORKSPACE \
            KUBE_ENV=$KUBE_ENV \
            REGISTRY=${{ env.REGISTRY }} \
            IMAGE_NAME=$IMAGE_NAME \
            IMAGE_TAG_SHA=${{ github.sha }} \
            make deploy
            
            echo "âœ… Deployment complete for ${SERVICE}"
          else
            echo "âš ï¸  No k8s/base/deployment.yaml found for ${SERVICE}, using direct kubectl"
            kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
              ${{ env.DEPLOYMENT_NAME }}=${FULL_IMAGE} \
              -n ${{ env.NAMESPACE }} \
              --record
            
            kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} --timeout=5m
          fi
      
      - name: Verify deployment
        if: matrix.service == 'web-ui'
        run: |
          echo "=== Current Deployment ==="
          kubectl get deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o wide
          
          echo ""
          echo "=== Current Image ==="
          kubectl get deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}'
          echo ""
          
          echo ""
          echo "=== Running Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }} -o wide

  summary:
    needs: [detect_changes, verify, build_and_push, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment summary
        run: |
          DEPLOY_OPTION="${{ github.event.inputs.deploy_option }}"
          CHANGED_SERVICES="${{ needs.detect_changes.outputs.changed_services }}"
          SERVICES_TO_DEPLOY="${{ needs.detect_changes.outputs.services_to_deploy }}"
          KUBE_ENV="${{ needs.detect_changes.outputs.kube_env }}"
          SKIP_VERIFY="${{ github.event.inputs.skip_verify }}"
          VERIFY_RESULT="${{ needs.verify.result }}"
          BUILD_RESULT="${{ needs.build_and_push.result }}"
          DEPLOY_RESULT="${{ needs.deploy.result }}"
          
          if [ "$SERVICES_TO_DEPLOY" == "[]" ] || [ -z "$SERVICES_TO_DEPLOY" ]; then
            echo "## â­ï¸ No Deployment Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`${{ github.event.inputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Deploy Option:** \`$DEPLOY_OPTION\`" >> $GITHUB_STEP_SUMMARY
            
            if [ "$DEPLOY_OPTION" == "Deploy all changed services" ]; then
              echo "- **Reason:** No service changes detected in this branch" >> $GITHUB_STEP_SUMMARY
              echo "- **Changed Services:** None" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Specific Service:** \`${{ github.event.inputs.service_name }}\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Reason:** Service specified but validation may have failed" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "- **Action:** Deployment skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Tip:** Changes are detected by comparing with the main branch. If this is a new branch with no differences, no deployment will occur." >> $GITHUB_STEP_SUMMARY
          else
            if [ "$DEPLOY_RESULT" == "success" ]; then
              echo "## âœ… Manual Deployment Successful" >> $GITHUB_STEP_SUMMARY
            else
              echo "## âŒ Deployment Failed or Incomplete" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`${{ github.event.inputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Kube Environment:** \`$KUBE_ENV\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Deploy Option:** \`$DEPLOY_OPTION\`" >> $GITHUB_STEP_SUMMARY
            
            if [ "$DEPLOY_OPTION" == "Deploy specific service" ]; then
              echo "- **Specific Service Selected:** \`${{ github.event.inputs.service_name }}\`" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Pipeline Stages" >> $GITHUB_STEP_SUMMARY
            
            if [ "$SKIP_VERIFY" == "true" ]; then
              echo "- **Verify:** â­ï¸ Skipped (skip_verify=true)" >> $GITHUB_STEP_SUMMARY
            else
              if [ "$VERIFY_RESULT" == "success" ]; then
                echo "- **Verify:** âœ… Success" >> $GITHUB_STEP_SUMMARY
              elif [ "$VERIFY_RESULT" == "skipped" ]; then
                echo "- **Verify:** â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **Verify:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            if [ "$BUILD_RESULT" == "success" ]; then
              echo "- **Build & Push:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Build & Push:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$DEPLOY_RESULT" == "success" ]; then
              echo "- **Deploy:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Deploy:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Services" >> $GITHUB_STEP_SUMMARY
            echo "- **Changed Services in Branch:** \`$CHANGED_SERVICES\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Services Deployed:** \`$SERVICES_TO_DEPLOY\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Namespace:** \`default\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          fi