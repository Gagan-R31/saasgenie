name: Manual Deploy to AKS

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to build and deploy'
        required: true
        type: string
        default: 'main'
      deploy_option:
        description: 'Deployment option'
        required: true
        type: choice
        options:
          - 'Deploy all changed services'
          - 'Deploy specific service'
        default: 'Deploy all changed services'
      service_name:
        description: 'Service name (only if "Deploy specific service" is selected)'
        required: false
        type: string

env:
  NAMESPACE: default
  DEPLOYMENT_NAME: demo
  REGISTRY: gaganr31

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      changed_services: ${{ steps.detect.outputs.changed_services }}
      services_to_deploy: ${{ steps.detect.outputs.services_to_deploy }}
      code_changed: ${{ steps.detect.outputs.code_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch_name }}

      - id: detect
        shell: bash
        run: |
          BRANCH_NAME="${{ github.event.inputs.branch_name }}"
          DEPLOY_OPTION="${{ github.event.inputs.deploy_option }}"
          SPECIFIC_SERVICE="${{ github.event.inputs.service_name }}"
          
          echo "Detecting changes in branch: ${BRANCH_NAME}"
          echo "Deploy option: ${DEPLOY_OPTION}"
          
          # Compare with main branch to detect what services exist/changed
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          else
            # If can't compare with main, just list all services
            CHANGED_FILES=$(find services -type f)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "---"

          code_changed=false
          changed_services=""

          if echo "$CHANGED_FILES" | grep -Eq '^(services|libs)/'; then
            code_changed=true
          fi

          for service_dir in services/*; do
            [ -d "$service_dir" ] || continue
            service_name=$(basename "$service_dir")
            if echo "$CHANGED_FILES" | grep -q "^services/$service_name/"; then
              changed_services="$changed_services $service_name"
            fi
          done

          if echo "$CHANGED_FILES" | grep -q '^libs/'; then
            for service_dir in services/*; do
              [ -d "$service_dir" ] || continue
              service_name=$(basename "$service_dir")
              changed_services="$changed_services $service_name"
            done
          fi

          changed_services=$(echo "$changed_services" | tr ' ' '\n' | sort -u | xargs)

          if [ -z "$changed_services" ]; then
            changed_services_json="[]"
            echo "No services with changes detected"
          else
            changed_services_json=$(printf '%s\n' $changed_services | jq -R . | jq -s -c .)
            echo "Services with changes: $changed_services"
          fi

          # Determine which services to actually deploy
          services_to_deploy=""
          if [ "$DEPLOY_OPTION" == "Deploy specific service" ]; then
            if [ -z "$SPECIFIC_SERVICE" ]; then
              echo "ERROR: service_name is required when 'Deploy specific service' is selected"
              exit 1
            fi
            
            # Check if the specific service exists
            if [ ! -d "services/$SPECIFIC_SERVICE" ]; then
              echo "ERROR: Service '$SPECIFIC_SERVICE' does not exist in the repository"
              echo "Available services:"
              ls -1 services/
              exit 1
            fi
            
            services_to_deploy="$SPECIFIC_SERVICE"
            echo "Deploying specific service: $SPECIFIC_SERVICE"
          else
            # Deploy all changed services
            services_to_deploy="$changed_services"
            echo "Deploying all changed services: $services_to_deploy"
          fi

          if [ -z "$services_to_deploy" ]; then
            services_to_deploy_json="[]"
            echo "No services to deploy"
          else
            services_to_deploy_json=$(printf '%s\n' $services_to_deploy | jq -R . | jq -s -c .)
            echo "Services to deploy: $services_to_deploy"
          fi

          echo "Changed services JSON: $changed_services_json"
          echo "Services to deploy JSON: $services_to_deploy_json"

          echo "code_changed=$code_changed" >> "$GITHUB_OUTPUT"
          echo "changed_services=$changed_services_json" >> "$GITHUB_OUTPUT"
          echo "services_to_deploy=$services_to_deploy_json" >> "$GITHUB_OUTPUT"

  build_and_push:
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.services_to_deploy != '[]' && needs.detect_changes.outputs.services_to_deploy != '' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect_changes.outputs.services_to_deploy) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to container registry
        uses: docker/login-action@v2
        with:
          username: ${{ env.REGISTRY }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Determine image details
        id: image
        run: |
          SERVICE="${{ matrix.service }}"
          BRANCH="${{ github.event.inputs.branch_name }}"
          
          # Determine image name
          if [ "$SERVICE" == "web-ui" ]; then
            IMAGE_NAME="demo"
          else
            IMAGE_NAME="mg-fp-$SERVICE"
          fi
          
          # Sanitize branch name for Docker tag
          BRANCH_TAG=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9._-]/-/g')
          
          # Use commit SHA for tag
          IMAGE_TAG="${{ github.sha }}"
          
          FULL_IMAGE="${{ env.REGISTRY }}/${IMAGE_NAME}:${IMAGE_TAG}"
          
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "branch_tag=${BRANCH_TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          
          echo "Image details:"
          echo "  - Service: ${SERVICE}"
          echo "  - Image name: ${IMAGE_NAME}"
          echo "  - Image tag: ${IMAGE_TAG}"
          echo "  - Branch tag: ${BRANCH_TAG}"
          echo "  - Full image: ${FULL_IMAGE}"

      - name: Build Docker Image
        run: |
          SERVICE="${{ matrix.service }}"
          IMAGE_NAME="${{ steps.image.outputs.image_name }}"
          IMAGE_TAG="${{ steps.image.outputs.image_tag }}"
          
          echo "Building ${SERVICE}..."
          cd services/${SERVICE}
          
          FALCON_HOME=$GITHUB_WORKSPACE KUBE_ENV=dev make build \
            REGISTRY=${{ env.REGISTRY }} \
            IMAGE_NAME=${IMAGE_NAME} \
            IMAGE_TAG_SHA=${IMAGE_TAG} \
            SHOULD_CACHE=true SHOULD_PUSH=false
          
          cd -
          
          echo "âœ… Build complete for ${SERVICE}"

      - name: Push Docker Image
        run: |
          IMAGE_NAME="${{ steps.image.outputs.image_name }}"
          IMAGE_TAG="${{ steps.image.outputs.image_tag }}"
          BRANCH_TAG="${{ steps.image.outputs.branch_tag }}"
          BASE_IMAGE="${{ env.REGISTRY }}/${IMAGE_NAME}"
          
          # Push commit SHA tag
          docker push ${BASE_IMAGE}:${IMAGE_TAG}
          echo "âœ… Pushed: ${BASE_IMAGE}:${IMAGE_TAG}"
          
          # Push branch-specific tag
          docker tag ${BASE_IMAGE}:${IMAGE_TAG} ${BASE_IMAGE}:${BRANCH_TAG}
          docker push ${BASE_IMAGE}:${BRANCH_TAG}
          echo "âœ… Pushed: ${BASE_IMAGE}:${BRANCH_TAG}"
          
          # Push additional tags for main/staging
          if [ "${{ github.event.inputs.branch_name }}" == "main" ]; then
            docker tag ${BASE_IMAGE}:${IMAGE_TAG} ${BASE_IMAGE}:latest
            docker push ${BASE_IMAGE}:latest
            echo "âœ… Pushed: ${BASE_IMAGE}:latest"
            
            docker tag ${BASE_IMAGE}:${IMAGE_TAG} ${BASE_IMAGE}:production
            docker push ${BASE_IMAGE}:production
            echo "âœ… Pushed: ${BASE_IMAGE}:production"
          elif [ "${{ github.event.inputs.branch_name }}" == "staging" ]; then
            docker tag ${BASE_IMAGE}:${IMAGE_TAG} ${BASE_IMAGE}:staging
            docker push ${BASE_IMAGE}:staging
            echo "âœ… Pushed: ${BASE_IMAGE}:staging"
          fi

  deploy:
    needs: [detect_changes, build_and_push]
    if: ${{ needs.detect_changes.outputs.services_to_deploy != '[]' && needs.detect_changes.outputs.services_to_deploy != '' }}
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.branch_name == 'main' && 'production' || github.event.inputs.branch_name == 'staging' && 'staging' || 'development' }}
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect_changes.outputs.services_to_deploy) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}

      - name: Determine image details
        id: image
        run: |
          SERVICE="${{ matrix.service }}"
          
          # Determine image name
          if [ "$SERVICE" == "web-ui" ]; then
            IMAGE_NAME="demo"
          else
            IMAGE_NAME="mg-fp-$SERVICE"
          fi
          
          IMAGE_TAG="${{ github.sha }}"
          FULL_IMAGE="${{ env.REGISTRY }}/${IMAGE_NAME}:${IMAGE_TAG}"
          
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "full_image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "service=${SERVICE}" >> $GITHUB_OUTPUT

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
          echo "Testing cluster connection..."
          kubectl cluster-info

      - name: Deploy to AKS
        run: |
          SERVICE="${{ steps.image.outputs.service }}"
          FULL_IMAGE="${{ steps.image.outputs.full_image }}"
          
          # Only deploy web-ui for now (you can extend this for other services)
          if [ "$SERVICE" == "web-ui" ]; then
            echo "Deploying ${SERVICE} to AKS..."
            echo "Image: ${FULL_IMAGE}"
            
            kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
              ${{ env.DEPLOYMENT_NAME }}=${FULL_IMAGE} \
              -n ${{ env.NAMESPACE }} \
              --record
            
            # Wait for rollout
            kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} --timeout=5m
            
            echo "âœ… Deployment complete for ${SERVICE}"
          else
            echo "â­ï¸  Skipping deployment for ${SERVICE} (no deployment configured)"
          fi
      
      - name: Verify deployment
        if: matrix.service == 'web-ui'
        run: |
          echo "=== Current Deployment ==="
          kubectl get deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o wide
          
          echo ""
          echo "=== Current Image ==="
          kubectl get deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.template.spec.containers[0].image}'
          echo ""
          
          echo ""
          echo "=== Running Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }} -o wide

  summary:
    needs: [detect_changes, build_and_push, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment summary
        run: |
          DEPLOY_OPTION="${{ github.event.inputs.deploy_option }}"
          CHANGED_SERVICES="${{ needs.detect_changes.outputs.changed_services }}"
          SERVICES_TO_DEPLOY="${{ needs.detect_changes.outputs.services_to_deploy }}"
          
          if [ "$SERVICES_TO_DEPLOY" == "[]" ] || [ -z "$SERVICES_TO_DEPLOY" ]; then
            echo "## â­ï¸ No Deployment Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`${{ github.event.inputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Deploy Option:** \`$DEPLOY_OPTION\`" >> $GITHUB_STEP_SUMMARY
            
            if [ "$DEPLOY_OPTION" == "Deploy all changed services" ]; then
              echo "- **Reason:** No service changes detected in this branch" >> $GITHUB_STEP_SUMMARY
              echo "- **Changed Services:** None" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Specific Service:** \`${{ github.event.inputs.service_name }}\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Reason:** Service specified but validation may have failed" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "- **Action:** Deployment skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Tip:** Changes are detected by comparing with the main branch. If this is a new branch with no differences, no deployment will occur." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Manual Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`${{ github.event.inputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Deploy Option:** \`$DEPLOY_OPTION\`" >> $GITHUB_STEP_SUMMARY
            
            if [ "$DEPLOY_OPTION" == "Deploy specific service" ]; then
              echo "- **Specific Service Selected:** \`${{ github.event.inputs.service_name }}\`" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "- **Changed Services in Branch:** \`$CHANGED_SERVICES\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Services Deployed:** \`$SERVICES_TO_DEPLOY\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Namespace:** \`default\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          fi